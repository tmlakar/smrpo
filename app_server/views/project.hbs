{{!-- Product backlog / sprints zavihka --}}

<div class="hbses">

<h3>{{name}}</h3>


<div class="row" style="padding-top:">

  {{!-- additional project infos --}}
  <div class="col-lg-2" style="padding-top: 20px !important; padding-right: 20px !important">
    {{!-- par informacij o projektu --}}
    <div class="card account-info" style="background-color: var(--c4) !important;">
                <div class="card-body">
                    <h5 class="card-title">Additional project information</h5>
                        {{!-- info --}}
                        <p class="card-text"><span style="color: var(--c2) !important;">Project description:</span>
                        <br>
                        {{info}}
                        </p>
                        {{!-- produktni vodja --}}
                        <p class="card-text"><span style="color: var(--c2) !important;">Product manager:</span>
                        <br>
                        {{#each productManagers as |productManager|}}
                          
                          <button  id="collaborator_circle" type="button" data-toggle="modal" data-proj="{{../id}}" data-id="{{collaborator._id}}" data-usr="{{collaborator.username}}" data-role="{{collaborator.project_role}}"
                          data-target="#modalnoOknoColl" class="btn btn-dark open-collaboratorEdit" style="background-color: var(--c1) !important; ">
                          {{firstLetterOfUsername productManager.username}}
                          </button>
                          
                        {{/each}}

                        </p>
                        {{!-- team members --}}
                        <p class="card-text"><span style="color: var(--c2) !important;">Scrum master:</span>
                        
                        {{#each scrumMasters as |scrumMaster|}}
                          <br>
                          <button  id="collaborator_circle" type="button" data-toggle="modal" data-proj="{{../id}}" data-id="{{collaborator._id}}" data-usr="{{collaborator.username}}" data-role="{{collaborator.project_role}}"
                          data-target="#modalnoOknoColl" class="btn btn-dark open-collaboratorEdit" style="background-color: var(--c5) !important; ">
                          {{firstLetterOfUsername scrumMaster.username}}
                          </button>
                        {{/each}}

                        </p>
                        {{!-- team members --}}
                        <p class="card-text"><span style="color: var(--c2) !important;">Team members:</span>
                        
                        {{#each teamMembers as |teamMember|}}
                          <br>
                          <button  id="collaborator_circle" type="button" data-toggle="modal" data-proj="{{../id}}" data-id="{{collaborator._id}}" data-usr="{{collaborator.username}}" data-role="{{collaborator.project_role}}"
                          data-target="#modalnoOknoColl" class="btn btn-dark open-collaboratorEdit" style="background-color: var(--c6) !important; ">
                          {{firstLetterOfUsername teamMember.username}}
                          </button>
                        {{/each}}

                        </p>

                </div>

            </div>



  </div>

{{!-- product backlog / sprints --}}
<div class="col-lg-10" style="margin-top: 20px !important">
  <ul class="nav nav-tabs">

    <li class="active"><a class="nav-link" data-toggle="tab" href="#backlog" onclick="location.href='#backlog'">Product backlog</a></li>
    <li><a class="nav-link" data-toggle="tab" href="#sprints" onclick="location.href='#sprints'">Sprints</a></li>

  </ul>

  {{!-- product backlog -> prikazovanje zgodb + dodajanje novih --}}
  <div class="tab-content">
    <div id="backlog" class=" active tab-pane fade">


      <div class="card-group">
      <div class="row">
    {{#each userStories as |story|}}
        <a type="button"data-toggle="modal" href="#info" onclick="location.href='#info'" class="modalnoOknoStory" data-target="#modalnoOknoStory" data-storyid="{{story._id}}"
         data-name="{{story.name}}" data-desc="{{story.aboutText}}" data-priority="{{story.priority}}" data-busval="{{story.businessValue}}"
         data-size="{{story.size}}" data-acc="{{story.tests}}" data-subt="{{story.subtasks}}" data-com="{{story.comments}}" data-pending="{{story.pending}}"
         data-owner="{{story.userStorieOwnerUsername}}" data-flags="{{story.flags}}" data-sprint1="{{story.sprint}}" data-projid="{{../id}}">
        <div class="card projekt-user-card" style="">
          <div class="card-body user-card-info">
            <div class="row" style="padding: 0px !important;">
                <div class=" col-lg-10" >
                  <h4><i>{{story.name}}</i></h4>
                </div>

                <div class="storyOwner_circle-d col-lg-2 " >
                    <button  id="storyOwner_circle" type="button"
                            class="btn btn-dark open-collaboratorEdit" disabled>
                            {{firstLetterOfUsername story.userStorieOwnerUsername}}
                    </button>
                  </div>
            </div>

            <p id="user-story-info"><span>Priority:</span> {{story.priority}}<br>
              <span>Business value:</span> {{story.businessValue}}<br>
              <span>Velocity:</span> {{story.size}}
            </p>

            <div class="row" style="padding: 0px !important;">
              <div class="card-flagss col-lg-12">
                <div class="row">
                {{#each story.flags as |flag|}}
                  <span id="flag-info">
                  {{flag}}
                  </span>
                {{/each}}
                </div>
              </div>
            </div>
            
            
          </div>

        </div>
        </a>

    {{/each}}

                  <script>
                            $(document).on("click", ".modalnoOknoStory", function () {
                              var projId = $(this).data('projid');
                                var storyId = $(this).data('storyid');
                                var storyName = $(this).data('name');
                                var storyAbout = $(this).data('desc');
                                var storyPriority = $(this).data('priority');
                                var storyBusinessValue = $(this).data('busval');
                                var storySize = $(this).data('size');
                                var storyTests = $(this).data('acc');
                                var storySubtasks = $(this).data('subt');
                                var storyComments = $(this).data('com');
                                var storyPendingFlag = $(this).data('pending');
                                var storyOwner = $(this).data('owner');
                                var storyFlags = $(this).data('flags');
                                var storySprint = $(this).data('sprint1');


                                {{!-- posiljanje na modalno okno --}}
                                {{!-- info --}}
                                $('#StoryName').html( storyName );
                                $('#StoryName1').val(storyName);
                                $('#storyDescription').val(storyAbout);
                                $('#storyPriority').val(storyPriority);
                                $('#storyBusinessValue').val(storyBusinessValue);
                                $('#storySize').val(storySize);
                                $('#storySprint').val(storySprint)

                                {{!-- acceptance tests - to je tabela --}}
                                
                                console.log(storyTests);
                                var tests = storyTests;
                                for (var i = 0; i < tests.length; i++) {
                                    var string = tests[i];
                                    string = '# ' + string;
                                    tests[i] = string;
                                } 
                                $('#storyAcceptanceTests').html(storyTests);

                                {{!-- tasks - objekti --}}
                                console.log(storySubtasks)
                                $('#storyTasks').html(storySubtasks);

                                {{!-- comments - objekti --}}
                                console.log(storyComments)
                                $('#storyComments').html(storyComments);
                                
                                
                                {{!-- $('#inputUsr').val(eventUsr); --}}
                                {{!-- $('#inputRole').val(eventRole);
                                var str = '/projects/' + projectId + '/edit-collaborator/' + eventId;
                                console.log(str);
                                var strD = '/projects/' + projectId + '/delete-collaborator/' + eventId;
                               
                                $('#collaboratorEdit').attr("action", str);
                                $('#collaboratorRemove').attr("action", strD); --}}
                                
                                
                                var editBasicInfo = '/project/'+ projId + '/userStory/'+ storyId + '/edit-info';
                                $('#editBasicInfo').attr("action", editBasicInfo);
                                var urlDelete = '/project/'+ projId + '/userStory/'+ storyId + '/delete';
                                $('#urlDelete').attr("action", urlDelete);

                            });
                    </script>


      </div>
      </div>

      <div class="modal fade" id="modalnoOknoStory" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg" role="document">
              <div class="modal-content modal-content-ekipa" style = "border: 3px solid var(--c2) !important;">
                <div class="modal-header modal-header-ekipa">
                  <h5 class="modal-title" id="StoryName" style="padding-top=10px; !important">{{story.name}}</h5> <!-- ni znotraj each in mi ne dela -->
                  <button type="button" class="close"  data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                  </button>
                </div>

                {{!-- zavihki za uporabnisko --}}
              <ul class="nav nav-tabs">
                  <li class="active"><a class="nav-link" data-toggle="tab" href="#info" onclick="location.href='#info'">Edit information</a></li>
                  <li><a class="nav-link" data-toggle="tab" href="#atest" onclick="location.href='#atest'">Add acceptance tests</a></li>
                  <li><a class="nav-link" data-toggle="tab" href="#tasks" onclick="location.href='#tasks'">Add end edit tasks</a></li>
                  <li><a class="nav-link" data-toggle="tab" href="#comments" onclick="location.href='#comments'">Add a comment</a></li>
                </ul>

                <!-- Tab 1 - Information -->
                <div class="tab-content">
                <div id="info" class=" active tab-pane fade">
                <div class="modal-body">
                  <form method="post" id="editBasicInfo" action="">

                      <!-- Assigned -->
                    <div class="storyOwner_circle-d" style="padding-right: 50px !important;">
                        <button  id="storyOwner_circle" type="button" class="btn btn-dark open-collaboratorEdit">
                            N 
                        </button>
                    </div>

                    <br>

                      <!-- Name -->
                    <div class="mb-3" style="padding-bottom: 10px !important">
                            <label class="form-label" style="padding-top: 10px !important">Name</label>
                            <input class="form-control input-form" name="name" id="StoryName1" aria-describedby="emailHelp" required>
                    </div>

                    
                      <!-- Description -->
                    <div class="mb-3" style="padding-bottom: 10px !important">
                            <label class="form-label" style="padding-top: 10px !important">Description</label>
                            <textarea class="form-control input-form-lg" name="aboutText"  id="storyDescription" aria-describedby="emailHelp" required></textarea>
                    </div>

                      <!-- Priority -->
                    <div class="mb-3" style="padding-bottom: 10px !important; width: 49% !important; float: Left;">
                            <label class="form-label" style="padding-top: 10px !important">Priority</label>
                            <input class="form-control input-form" name="priority" id="storyPriority"  list="priority_list"aria-describedby="emailHelp" required>
                            <datalist id="priority_list">
                            <option value="Must have">  </option>
                            <option value="Should have"></option>
                            <option value="Could have"></option>
                            <option value="Won't have this time"></option>

                            </datalist>
                    </div>
                    <div class="clear"></div>
                    <!-- value --->
                    <div class="mb-3" style="padding-bottom: 10px !important; width: 49% !important; float: Right">
                        <label class="form-label" style="padding-top: 10px !important">Business value</label>
                        <input class="form-control input-form" name="businessValue" id="storyBusinessValue" aria-describedby="emailHelp" type="number" min="1" max="10" required>                          
                    </div>

                    <!-- Size --->
                    <div class="mb-3" style="padding-bottom: 10px !important; width: 49% !important; float: Left;">
                        <label class="form-label" style="padding-top: 10px !important">Size</label>
                        <input class="form-control input-form" name="size" id="storySize" aria-describedby="emailHelp" type="number" min="1" required>
                    </div>
                    <div class="clear"></div>
                    <!-- Sprint -->
                    <div class="mb-3" style="padding-bottom: 10px !important; width: 49% !important; float: Right">
                        <label class="form-label" style="padding-top: 10px !important">Sprint</label>
                        <input class="form-control input-form" name="sprint" id="storySprint" type="number" min="0" aria-describedby="emailHelp">
                        <!-- placeholder sprint if already defined? -->
                    </div>


                    <br><br>

                      <!-- save changes -form-->     
                            
                      <!-- se pogoji kdo lahko spreminja pa pod katerimi pogoji-->  
                      
                      <button type="submit" class="btn submit-form" style="background-color: var(--c5)!important; float: Left; !important">Save changes</button></form>
                      <form id="urlDelete" method="post" action="">
                      <button type="submit" class="btn submit-form" style="background-color: var(--c1)!important; float: Right; !important">Delete story</button>
                      </form>
              </div>
              
            
                </div>

              <!-- Tab 2 - Acceptance test -->
              <div id="atest" class="tab-pane fade">
              <div class="modal-body">
                  <form method="post" id="" action="url">
                    
                    <!-- Acceptance tests -->
                    <div  class="mb-3" style="padding-bottom: 10px !important">
                      <!-- verjetno each -->
                      
                        <p  id="storyAcceptanceTests" style="color: var(--c3) !important;"></p>
                      
                    </div>

                      <!-- Add acceptance test - form -->
                    <div class="mb-3" style="padding-bottom: 10px !important">
                            <label class="form-label" style="padding-top: 10px !important">Add acceptance test</label>
                            <input class="form-control input-form" name="aboutText" id="info" aria-describedby="emailHelp" required>
                    </div>

                    <!-- Add test -->           
                      <button type="submit" class="btn submit-form" style="background-color: var(--c5)!important; float: right; !important">Add</button>

                </form>
              </div> <!-- end modal body -->


              </div>

              <!-- Tab 3 - Tasks -->
              <div id="tasks" class="tab-pane fade">
              <div class="modal-body">
                  <form method="post" id="" action="url">

                    <!-- Tasks -->
                    <div class="mb-3" style="padding-bottom: 10px !important">
                       <!-- Each? -->
                      <div class="row">                    
                        <div class="col-lg-9">
                          <label for="tasks" style="color: var(--c3) !important;">
                          <input type="checkbox" name="tasks" id="tasks" aria-describedby="emailHelp"/>
                          A je smiselno dat druge barve tekst k je narjen?</label>
                        </div>
                           
                        <div class="col-lg-3">

                          <button type="button" data-toggle="modal" data-target="#modalEditTask" class="btn button-mini" style="background-color: var(--c5)!important; float:right; margin-left:5px;">Edit</button>
                          
                          <button  id="taskOwner_circle" type="button" class="btn btn-dark open-collaboratorEdit" style="float:right;">
                            N <!-- N kot Neznam (povezat backenda); A bomo tudi dodale datalist vseh uporabnikov?-->
                          </button>
                                                  
                        </div>

                        {{!-- modalno okno za spreminjanje nalog --}}
                        <div class="modal fade" id="modalEditTask" tabindex="-1" role="dialog" aria-hidden="true">
                          <div class="modal-dialog" style="padding-top: 150px !important;">
                            <div class="modal-content modal-content-ekipa" style="border: 3px solid var(--c2) !important;"> 
                                <div class="modal-header modal-header-ekipa">
                                <h5 class="modal-title" id="exampleModalLabel" style="padding-top=10px; !important">Edit task</h5>
                                <button type="button" class="close"  data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                                </button>
                                </div>
                                <div class="modal-body">
                                  <!-- Edit existing tasks -->
                                  <div class="mb-3" style="padding-bottom: 10px !important; width: 84% !important; float: Left;">
                                    <label class="form-label" style="padding-top: 10px !important;">Task</label>
                                    <input class="form-control input-form" name="aboutText" id="info" aria-describedby="emailHelp" required> <!-- placeholder in value -->
                                  </div>
                                  <div class="clear"></div>
                                  <div class="mb-3" style="padding-bottom: 10px !important; width: 14% !important; float: Right;">
                                    <label class="form-label" style="padding-top: 10px !important;">Hours</label>
                                    <input class="form-control input-form" name="taskHours" id="taskHours" type="number" min="1" aria-describedby="emailHelp" required> <!-- placeholder in value -->
                                  </div>

                                  <br>

                                  <button type="submit" class="btn submit-form" style="background-color: var(--c5)!important; float: Left; !important">Save changes</button>
                                  <button type="submit" class="btn submit-form" style="background-color: var(--c1)!important; float: Right; !important">Delete task</button>
                                </div>
                              </div>
                            </div>
                        </div>

                      <!-- end second modal window -->
                      </div>
                      <br>
                      <p id="storyTasks"></p>  
                    </div>

                    <!-- Add new tasks -form-->
                    <div class="mb-3" style="padding-bottom: 10px !important; width: 84% !important; float: Left;">
                            <label class="form-label" style="padding-top: 10px !important;">Add task</label>
                            <input class="form-control input-form" name="aboutText" id="info" aria-describedby="emailHelp" required>
                    </div>
                    <div class="clear"></div>
                    <div class="mb-3" style="padding-bottom: 10px !important; width: 14% !important; float: Right;">
                            <label class="form-label" style="padding-top: 10px !important;">Hours</label>
                            <input class="form-control input-form" name="taskHours" id="taskHours" type="number" min="1" aria-describedby="emailHelp" required>
                    </div>

                    <!-- save changes -->           
                    <button type="submit" class="btn submit-form" style="background-color: var(--c5)!important; float: right; !important">Add</button>
                                    
                </form>
              </div> <!-- end modal body -->
              </div>

              <!-- Tab 4 - Comments -->
              <div id="comments" class="tab-pane fade">
              <div class="modal-body">
                  <form method="post" id="" action="url">

                    <!-- All comments -->
                    <!-- datalist? -->
                    <div class="row">
                      <div class="col-lg-1">
                        <button  id="taskOwner_circle" type="button" class="btn btn-dark open-collaboratorEdit" style="float:left;" disabled> <!-- nism zihr, če je ok tuki id taskOwner? -->
                            N 
                        </button>
                        
                      </div>
                      <div class="col-lg-11">
                        <p style="color: var(--c3)!important;">Moj komentar je tukaj :)</p>
                      </div>
                      <br>
                    </div>
                    <p id="storyComments"></p>

                      <!-- Add comment -form -->
                    <div class="mb-3" style="padding-bottom: 10px !important">
                            <label class="form-label" style="padding-top: 10px !important">Add comment</label>
                            <textarea class="form-control input-form-lg" name="aboutText" id="info" aria-describedby="emailHelp" required></textarea>
                    </div>

                    <!-- save changes -->
                      <button type="submit" class="btn submit-form" style="background-color: var(--c5)!important; float: right; !important">Comment</button>

                  </form>
              </div> <!-- end modal body -->
              </div>

            </div>
        </div>
        </div>
        </div>



        {{!-- nova uporabniska zgodba -> samo product manager pa scrum master --}}
        {{#if scrumMaster}}
        <a href="/project/{{id}}/new-user-story"><button id="" type="button" class="btn btn-dark dodaj-uporabnika fixed-bottom float-right" style="background-color: var(--c1) !important; border: 3px solid var(--c1) !important"><i class="fa-solid fa-plus dodaj"></i></button></a><br>
        {{/if}}
        {{#if productManager}}
        <a href="/project/{{id}}/new-user-story"><button id="" type="button" class="btn btn-dark dodaj-uporabnika fixed-bottom float-right" style="background-color: var(--c1) !important; border: 3px solid var(--c1) !important"><i class="fa-solid fa-plus dodaj"></i></button></a><br>
        {{/if}}

</div>

      {{!-- sprinti --}}
      <div id="sprints" class="tab-pane fade">


      <div class="row" style="">
        {{!---prikaz dodanih sprintov, ki se jih pridobi iz apija --}}
        {{#each sprints as |sprint|}}
            <div class="card projekt-sprint col-sm-3" style="">
              <div class="card-body">
                <h4 ><b>Sprint {{number}}</b></h4>
                <p><span>From:</span> {{formatirajDatum sprint.startDate}}<br>
                <span>To:</span> {{formatirajDatum sprint.endDate}}<br><br>
                <span>Sprint size:</span> {{sprint.sprintSize}}</p>

              </div>
            </div>

        {{/each}}
         {{!---prikaz dodanih sprintov, ki se jih pridobi iz apija --}}
        {{#each inProcessSprints as |sprint|}}
            <div class="card projekt-sprint col-sm-3" style="">
              <div class="card-body">
                <h4 ><b>Sprint {{number}}</b></h4>
                <p><span>From:</span> {{formatirajDatum sprint.startDate}}<br>
                <span>To:</span> {{formatirajDatum sprint.endDate}}<br><br>
                <span>Sprint size:</span> {{sprint.sprintSize}}</p>

              </div>
            </div>
          {{!-- gumba za edit projectov --}}
        {{/each}}
        {{#each futureSprints as |sprint|}}
            <div class="card projekt-sprint col-sm-3" style="">
              <div class="card-body">
                <h4 ><b>Sprint {{number}}</b></h4>
                <p><span>From:</span> {{formatirajDatum sprint.startDate}}<br>
                <span>To:</span> {{formatirajDatum sprint.endDate}}<br><br>
                <span>Sprint size:</span> {{sprint.sprintSize}}</p>

              </div>
            </div>
          {{!-- gumba za edit projectov --}}
        {{/each}}
      </div>
      {{#if scrumMaster}}
        {{!-- gumb za dodajanje novega sprinta - se pokaže le če je prijavljen admin--}}
        <div><a href="/sprint-new/{{id}}"><button id="" type="button" class="btn btn-dark dodaj-uporabnika fixed-bottom float-right"><i class="fa-solid fa-plus dodaj"></i></button></a></div><br>
      {{/if}}




    </div>
</div>
</div>






<script type="text/javascript">
$(document).ready(function(){
    var anchorHash = window.location.href.toString();
    if( anchorHash.lastIndexOf('#') != -1 ) {
        anchorHash = anchorHash.substr(anchorHash.lastIndexOf('#'));
        if( $('a[href="'+ anchorHash +'"]').length > 0 ) {
            $('a[href="'+ anchorHash +'"]').trigger('click');
        }
    }
});
</script>

</div>



</div>

{{!-- modal window if sprint was successfully added --}}
<div id="myModal31" class=" modal" tabindex="-1" role="dialog">
            <div class="modal-dialog" role="document">
                <div class="modal-content alert-s-200">
                <div class="modal-header" style="background-color: var(--c5) !important">
                    <h5 class="modal-title">Success!</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p>New sprint has been successfully created!</p>
                </div>

                </div>
            </div>
        </div>

{{#if successfullyAddedSprint}}
<script>
    $(document).ready(function(){
        $("#myModal31").modal('show');

        setTimeout(function() {

            $('#myModal31').modal('hide');
        }, 7000);
    });
</script>
{{/if}}




{{!-- modal window if userStory was successfully added --}}
<div id="myModal40" class=" modal" tabindex="-1" role="dialog">
            <div class="modal-dialog" role="document">
                <div class="modal-content alert-s-200">
                <div class="modal-header" style="background-color: var(--c5) !important">
                    <h5 class="modal-title">Success!</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p>New user story has been successfully created!</p>
                </div>

                </div>
            </div>
        </div>

{{#if successfullyAddedStory}}
<script>
    $(document).ready(function(){
        $("#myModal40").modal('show');

        setTimeout(function() {

            $('#myModal40').modal('hide');
        }, 7000);
    });
</script>
{{/if}}